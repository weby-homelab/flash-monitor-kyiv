<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>–°–í–Ü–¢–õ–û‚ö°–ë–ï–ó–ü–ï–ö–ê (–ö–∏—ó–≤) ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å–≤—ñ—Ç–ª–∞ —Ç–∞ –±–µ–∑–ø–µ–∫–∏</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å–≤—ñ—Ç–ª–∞, –ø–æ–≤—ñ—Ç—Ä—è–Ω–∏—Ö —Ç—Ä–∏–≤–æ–≥, —Ä–∞–¥—ñ–∞—Ü—ñ–π–Ω–æ–≥–æ —Ñ–æ–Ω—É —Ç–∞ —è–∫–æ—Å—Ç—ñ –ø–æ–≤—ñ—Ç—Ä—è —É –ö–∏—î–≤—ñ. –î–∞–Ω—ñ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.">
    
    <!-- PWA Settings -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1E122A">
    <link rel="icon" type="image/svg+xml" href="/static/icon.svg">
    <link rel="apple-touch-icon" href="/static/icon.svg">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #1E122A; color: white; text-align: center; padding: 20px; margin: 0; }
        .container { max-width: 600px; margin: 0 auto; }
        
        h1 { font-weight: 500; letter-spacing: 0.5px; color: #fff; margin-bottom: 30px; }

        .card { 
            background: #1E122A; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .title { color: #aaa; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; font-weight: 600; }
        .value { font-size: 28px; font-weight: bold; }
        .status-text { font-size: 16px; margin-top: 5px; color: #ccc; }
        
        /* Alerts */
        .alert-card.active { background: #d32f2f; border: none; animation: pulse 2s infinite; }
        .alert-card.clear { background: #388e3c; border: none; }
        .alert-card .title, .alert-card .status-text { color: rgba(255,255,255,0.8); }
        .alert-card .value { color: #fff !important; text-shadow: none !important; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
        }

        .chart { width: 100%; border-radius: 8px; margin-top: 10px; background: #1E122A; }

        .footer { margin-top: 40px; font-size: 12px; color: #666; text-align: center; }
        .footer a { color: #888; text-decoration: none; }
        .footer a:hover { color: #fff; text-decoration: underline; }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: rgba(30, 18, 42, 0.95);
            border: 1px solid #3a2d4d;
            border-left: 5px solid #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            opacity: 0;
            transform: translateX(50px);
            transition: opacity 0.3s, transform 0.3s;
            text-align: left;
            max-width: 300px;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.down { border-left-color: #EF9A9A; }
        .toast.alert { border-left-color: #ff5252; }
        .toast-title { font-weight: bold; font-size: 16px; display: flex; align-items: center; gap: 8px; }

        /* Stats grid */
        .stats-grid { color: #aaa; font-size: 14px; margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .stats-item { background: #2a2a2a; padding: 5px 10px; border-radius: 6px; }
        .stats-item b { color: #fff; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 15px; }
        td { padding: 10px 8px; border-bottom: 1px solid #3a2d4d; text-align: left; }
        tr:last-child td { border-bottom: none; }
        .td-time { white-space: nowrap; width: 100px; color: #ccc; }
        .td-event { font-weight: bold; }
        .td-event span { display: block; font-weight: normal; font-size: 0.9em; color: #aaa; text-align: right; }

    </style>
</head>
<body>
    <div id="toast-container"></div>
    <div class="container">
        <h1 style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            –°–í–Ü–¢–õ–û‚ö°–ë–ï–ó–ü–ï–ö–ê
            <span id="audio-toggle" style="cursor:pointer; font-size:24px; opacity:0.5;" title="–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫–æ–≤—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è">üîï</span>
        </h1>

        <!-- Air Raid Alert -->
        <div id="alert-card" class="card alert-card clear">
            <div class="title">–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ (–ö–∏—ó–≤)</div>
            <div class="value" id="alert-status">--</div>
            <div class="status-text" id="alert-location">--</div>
        </div>

        <!-- Alerts Map Iframe -->
        <div class="card" style="padding: 0; overflow: hidden; height: 400px;">
            <iframe src="https://alerts.in.ua/?minimal=true" width="100%" height="100%" frameborder="0" style="border:0;"></iframe>
        </div>

        <!-- Air Quality (Moved up) -->
        <div class="card">
            <div class="title" id="aqi-title">–Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è</div>
            <div class="value" id="aqi-val">--</div>
            <div class="status-text" id="aqi-status">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div class="stats-grid">
                <div class="stats-item">PM2.5: <b id="aqi-pm25">--</b></div>
                <div class="stats-item">PM10: <b id="aqi-pm10">--</b></div>
                <div class="stats-item">üå°Ô∏è <b id="aqi-temp">--</b> ¬∞C</div>
                <div class="stats-item">üíß <b id="aqi-hum">--</b> %</div>
                <div class="stats-item">üí® <b id="aqi-wind">--</b></div>
            </div>
        </div>

        <!-- Radiation background (Moved up) -->
        <div class="card">
            <div class="title">–†–∞–¥—ñ–∞—Ü—ñ–π–Ω–∏–π —Ñ–æ–Ω</div>
            <div class="value" style="color: #4fc3f7;">
                <span id="rad-val">--</span> <span style="font-size: 16px; color: #888;">–º–∫–ó–≤/–≥–æ–¥</span>
            </div>
            <div class="status-text" style="color: #4caf50;">–í –Ω–æ—Ä–º—ñ</div>
        </div>

        <!-- Light Status -->
        <div class="card">
            <div class="title">–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è (–ì—Ä—É–ø–∞ 36.1)</div>
            <div class="value" id="light-val">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div class="status-text" id="light-status">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
        </div>

        <!-- Light Chart -->
        <div class="card">
            <div class="title">–ì—Ä–∞—Ñ—ñ–∫ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</div>
            <img src="/static/chart.png?v={{ ts }}" id="daily-chart" class="chart" alt="">
        </div>

        <!-- Weekly Chart -->
        <div class="card">
            <div class="title">–¢–∏–∂–Ω–µ–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫</div>
            <img src="/static/weekly.png?v={{ ts }}" id="weekly-chart" class="chart" alt="">
        </div>

        <!-- Recent Events -->
        <div class="card">
            <div class="title">–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–¥—ñ—ó</div>
            <table>
                <tbody id="events-table-body">
                    <tr><td colspan="2" style="text-align: center;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            –û–Ω–æ–≤–ª–µ–Ω–æ: <span id="last-updated">--:--:--</span><br>
            ¬© 2026 Weby Homelab<br>
            Built to survive 12h+ blackouts & grid attacks since 2022
        </div>
    </div>

    <script>
        let lastLightStatus = null;
        let wasAlertActive = false;
        let audioCtx = null;
        let audioEnabled = localStorage.getItem('audioEnabled_flash') === 'true';

        const audioToggle = document.getElementById('audio-toggle');
        if (audioEnabled) {
            audioToggle.innerText = "üîî";
            audioToggle.style.opacity = "1";
        }

        audioToggle.addEventListener('click', function() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            audioEnabled = !audioEnabled;
            localStorage.setItem('audioEnabled_flash', audioEnabled);
            this.innerText = audioEnabled ? "üîî" : "üîï";
            this.style.opacity = audioEnabled ? "1" : "0.5";
            
            if (audioEnabled && "Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission();
                }
            }
            
            if (audioEnabled) {
                playDing(); 
            }
        });

        function playDing() {
            if (!audioCtx || !audioEnabled) return;
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.5);
            
            gainNode.gain.setValueAtTime(0.02, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.5);
            
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.5);
        }

        function showToast(title, body, type) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            let icon = 'üí°';
            if (type === 'down') icon = 'üî¥';
            if (type === 'alert') icon = 'üö®';
            
            toast.innerHTML = `
                <div class="toast-title"><span>${icon}</span> ${title}</div>
                <div>${body}</div>
            `;
            
            container.appendChild(toast);
            void toast.offsetWidth;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 6000);
        }

        function showNotification(title, body, iconUrl) {
            if (audioEnabled && "Notification" in window && Notification.permission === "granted") {
                new Notification(title, {
                    body: body,
                    icon: iconUrl || "/static/icon.svg"
                });
            }
        }

        function refreshCharts() {
            const ts = Date.now();
            document.getElementById('daily-chart').src = "/static/chart.png?v=" + ts;
            const weeklyChart = document.getElementById('weekly-chart');
            if (weeklyChart) weeklyChart.src = "/static/weekly.png?v=" + ts;
            console.log('Charts refreshed at ' + new Date().toLocaleTimeString());
        }

        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // 1. Light Status
                    const lightVal = document.getElementById('light-val');
                    const currentStatus = data.light;
                    
                    if (currentStatus === 'on') {
                        lightVal.innerHTML = '<span style="color: #FFD700; text-transform: uppercase;">üí° –°–≤—ñ—Ç–ª–æ —î</span>';
                    } else if (currentStatus === 'off') {
                        lightVal.innerHTML = '<span style="color: #FFFFFF; text-transform: uppercase;">‚úñÔ∏è –°–≤—ñ—Ç–ª–æ –∑–Ω–∏–∫–ª–æ</span>';
                    }
                    document.getElementById('light-status').innerHTML = data.light_event;

                    if (lastLightStatus && currentStatus !== lastLightStatus) {
                        playDing();
                        if (currentStatus === 'on') {
                            showToast("–°–≤—ñ—Ç–ª–æ –∑'—è–≤–∏–ª–æ—Å—è!", "–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.", "up");
                            showNotification("üí° –°–≤—ñ—Ç–ª–æ –∑'—è–≤–∏–ª–æ—Å—è!", "–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ.");
                        } else {
                            showToast("–°–≤—ñ—Ç–ª–æ –∑–Ω–∏–∫–ª–æ!", "–ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.", "down");
                            showNotification("üî¥ –°–≤—ñ—Ç–ª–æ –∑–Ω–∏–∫–ª–æ!", "–ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.");
                        }
                        // Refresh charts immediately on status change
                        refreshCharts();
                    }
                    lastLightStatus = currentStatus;

                    // 1.5 History Table
                    const tbody = document.getElementById('events-table-body');
                    if (data.light_history && data.light_history.length > 0) {
                        let rowsHtml = '';
                        data.light_history.forEach(ev => {
                            const color = ev.icon === 'üü¢' ? '#4CAF50' : '#EF9A9A';
                            rowsHtml += `<tr>
                                <td class="td-time">${ev.time}</td>
                                <td class="td-event" style="color: ${color};">${ev.icon} ${ev.text}<span>${ev.desc}</span></td>
                            </tr>`;
                        });
                        tbody.innerHTML = rowsHtml;
                    } else {
                        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center; color: #aaa;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –ø—Ä–æ –ø–æ–¥—ñ—ó</td></tr>';
                    }

                    // 2. Air Raid Alert
                    const isCityAlert = !!data.alert.city;
                    if (isCityAlert && !wasAlertActive) {
                        playDing(); setTimeout(playDing, 300);
                        showToast("–ü–û–í–Ü–¢–†–Ø–ù–ê –¢–†–ò–í–û–ì–ê!", "–ü—Ä–æ–π–¥—ñ—Ç—å –≤ —É–∫—Ä–∏—Ç—Ç—è!", "alert");
                        showNotification("üö® –¢–†–ò–í–û–ì–ê (–ö–ò–á–í)!", "–ü—Ä–æ–π–¥—ñ—Ç—å –≤ —É–∫—Ä–∏—Ç—Ç—è!");
                    }
                    wasAlertActive = isCityAlert;

                    const alertCard = document.getElementById('alert-card');
                    if (data.alert.city) {
                        alertCard.className = 'card alert-card active';
                        document.getElementById('alert-status').innerText = '–¢–†–ò–í–û–ì–ê (–ö–ò–á–í)!';
                        document.getElementById('alert-location').innerText = '–ü—Ä–æ–π–¥—ñ—Ç—å –≤ —É–∫—Ä–∏—Ç—Ç—è!';
                    } else if (data.alert.region) {
                        alertCard.className = 'card alert-card active';
                        document.getElementById('alert-status').innerText = '–¢–†–ò–í–û–ì–ê (–û–ë–õ–ê–°–¢–¨)';
                        document.getElementById('alert-location').innerText = '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å';
                    } else {
                        alertCard.className = 'card alert-card clear';
                        document.getElementById('alert-status').innerText = '–°–ü–û–ö–Ü–ô–ù–û';
                        document.getElementById('alert-location').innerText = '–¢—Ä–∏–≤–æ–≥–∏ –Ω–µ–º–∞—î';
                    }

                    // 3. AQI
                    if (data.aqi) {
                        const val = data.aqi.aqi;
                        const aqiVal = document.getElementById('aqi-val');
                        aqiVal.innerText = val;
                        document.getElementById('aqi-status').innerText = data.aqi.text;
                        document.getElementById('aqi-title').innerHTML = "–Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è:<br><span style='font-size: 0.8em; font-weight: normal; color: #888;'>" + data.aqi.location + "</span>";
                        document.getElementById('aqi-pm25').innerText = data.aqi.pm25;
                        document.getElementById('aqi-pm10').innerText = data.aqi.pm10;
                        document.getElementById('aqi-temp').innerText = data.aqi.temp;
                        document.getElementById('aqi-hum').innerText = data.aqi.hum;
                        document.getElementById('aqi-wind').innerText = data.aqi.wind_dir + ', ' + data.aqi.wind_speed + ' –∫–º/–≥–æ–¥';

                        if (val <= 50) aqiVal.style.color = '#4caf50'; // Green
                        else if (val <= 100) aqiVal.style.color = '#ffeb3b'; // Yellow
                        else if (val <= 150) aqiVal.style.color = '#ff9800'; // Orange
                        else aqiVal.style.color = '#f44336'; // Red
                    }

                    // 4. Radiation
                    document.getElementById('rad-val').innerText = data.radiation.level;

                    document.getElementById('last-updated').innerText = data.timestamp;
                });
        }

        setInterval(updateStatus, 60000);
        setInterval(refreshCharts, 300000); // 5 minutes periodic refresh
        setTimeout(updateStatus, 200);
        setTimeout(refreshCharts, 500); // Initial refresh after load

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(reg => console.log('SW ok'));
            });
        }
    </script>
</body>
</html>
