<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–í–Ü–¢–õ–û‚ö°–ë–ï–ó–ü–ï–ö–ê (–ö–∏—ó–≤) ‚Äî –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ —Å–≤—ñ—Ç–ª–∞ —Ç–∞ –±–µ–∑–ø–µ–∫–∏</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    
    <link rel="icon" type="image/png" href="/static/icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #0d0d0d;
            --surface: #1a1a1a;
            --surface-hover: #222222;
            --border: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --accent: #a78bfa; /* Amethyst */
            --danger: #ef4444;
            --success: #22c55e;
            --warning: #f59e0b;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: env(safe-area-inset-top) 16px 40px;
        }

        .container { width: 100%; max-width: 500px; }

        header { 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 24px 0;
            margin-bottom: 8px;
        }

        .logo { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.5px; }
        .logo span { color: var(--accent); }

        .status-badge {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); }
        .status-dot.pulse { animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card:active { transform: scale(0.98); }

        .card-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            display: block;
        }

        .status-val { font-size: 1.75rem; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .status-desc { font-size: 0.95rem; color: var(--text-secondary); margin-top: 8px; line-height: 1.4; }

        /* Power Specific */
        .status-on { border-color: rgba(34, 197, 94, 0.3); }
        .status-off { border-color: rgba(239, 68, 68, 0.3); }
        .status-off .status-val { color: var(--danger); }

        /* Alert Card */
        .alert-active { background: rgba(239, 68, 68, 0.1); border-color: var(--danger); animation: danger-pulse 2s infinite; }
        @keyframes danger-pulse {
            0% { border-color: rgba(239, 68, 68, 0.3); }
            50% { border-color: var(--danger); }
            100% { border-color: rgba(239, 68, 68, 0.3); }
        }

        /* AQI Grid */
        .aqi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 16px; }
        .aqi-item { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; }
        .aqi-label { font-size: 0.7rem; color: var(--text-secondary); display: block; margin-bottom: 4px; }
        .aqi-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; }

        /* Charts */
        .chart-container { margin-top: 8px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); cursor: pointer; }
        .chart-container img { width: 100%; display: block; }

        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Modal / Zoom */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal img { max-width: 100%; max-height: 90vh; border-radius: 8px; }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--accent);
            color: #000;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 2000;
            white-space: nowrap;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <div class="logo">–°–í–Ü–¢–õ–û<span>‚ö°</span>–ë–ï–ó–ü–ï–ö–ê</div>
            <div class="status-badge">
                <div class="status-dot pulse"></div>
                <div id="update-time">LIVE</div>
            </div>
        </header>

        <!-- Power Card -->
        <div id="light-card" class="card">
            <span class="card-label" id="group-title">–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è (–ì—Ä—É–ø–∞ ...)</span>
            <div class="card-content">
                <div id="light-val" class="status-val">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                <div id="light-status" class="status-desc">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>
            </div>
        </div>

        <!-- Alert Card -->
        <div id="alert-card" class="card">
            <span class="card-label">–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Ç—Ä–∏–≤–æ–≥–∞ (–ö–∏—ó–≤)</span>
            <div class="status-val" id="alert-val">---</div>
            <div class="status-desc" id="alert-status">–¢—Ä–∏–≤–æ–≥–∏ –Ω–µ–º–∞—î</div>
        </div>

        <!-- AQI Card -->
        <div class="card">
            <span class="card-label">–Ø–∫—ñ—Å—Ç—å –ø–æ–≤—ñ—Ç—Ä—è</span>
            <div style="display: flex; align-items: baseline; gap: 12px;">
                <span id="aqi-num" style="font-size: 2.5rem; font-weight: 700;">--</span>
                <span id="aqi-text" style="font-size: 1.1rem; font-weight: 500; color: var(--success);">---</span>
            </div>
            <div id="aqi-loc" style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">---</div>
            
            <div class="aqi-grid">
                <div class="aqi-item"><span class="aqi-label">PM2.5</span><span class="aqi-val" id="pm25">--</span></div>
                <div class="aqi-item"><span class="aqi-label">PM10</span><span class="aqi-val" id="pm10">--</span></div>
                <div class="aqi-item"><span class="aqi-label">üå°Ô∏è –¢–µ–º–ø.</span><span class="aqi-val" id="temp">--</span></div>
                <div class="aqi-item"><span class="aqi-label">üíß –í–æ–ª–æ–≥—ñ—Å—Ç—å</span><span class="aqi-val" id="hum">--</span></div>
            </div>
            <div class="status-desc" id="wind-status" style="margin-top: 12px; font-size: 0.85rem;">---</div>
        </div>

        <!-- Radiation Card -->
        <div class="card">
            <span class="card-label">–†–∞–¥—ñ–∞—Ü—ñ–π–Ω–∏–π —Ñ–æ–Ω</span>
            <div class="status-val" id="rad-val">-- –º–∫–ó–≤/–≥–æ–¥</div>
            <div class="status-desc" id="rad-status">–í –Ω–æ—Ä–º—ñ</div>
        </div>

        <!-- Charts -->
        <div style="margin-bottom: 12px; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">–ì—Ä–∞—Ñ—ñ–∫ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</div>
        <div class="chart-container" onclick="zoomImage(this.querySelector('img').src)">
            <img id="main-chart" src="/static/chart.png?t=0" alt="Daily Chart">
        </div>

        <div style="margin: 20px 0 12px; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;">–¢–∏–∂–Ω–µ–≤–∏–π –≥—Ä–∞—Ñ—ñ–∫</div>
        <div class="chart-container" onclick="zoomImage(this.querySelector('img').src)">
            <img id="weekly-chart" src="/static/weekly.png?t=0" alt="Weekly Chart">
        </div>

        <!-- Group Schedule Text -->
        <div style="margin: 20px 0 12px; font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase;" id="group-schedule-header">–ì—Ä–∞—Ñ—ñ–∫ –≥—Ä—É–ø–∏ ...</div>
        <div id="schedule-text" style="background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 20px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; line-height: 1.5; margin-bottom: 24px;">
            –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...
        </div>

        <div class="footer">
            –û–Ω–æ–≤–ª–µ–Ω–æ: <span id="last-update">---</span><br>
            ¬© 2026 Weby Homelab. Made with ‚ù§Ô∏è in Kyiv under air raid sirens and blackouts
        </div>
    </div>

    <div id="zoom-modal" class="modal" onclick="this.style.display='none'">
        <img id="zoomed-img" src="" alt="Zoomed">
    </div>

    <div id="toast">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>

    <script>
        let lastLightStatus = null;
        let wasAlertActive = false;

        function showToast(title, msg, type) {
            const toast = document.getElementById('toast');
            toast.innerText = title;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function zoomImage(src) {
            const modal = document.getElementById('zoom-modal');
            const img = document.getElementById('zoomed-img');
            img.src = src;
            modal.style.display = 'flex';
        }

        function refreshCharts() {
            const t = Date.now();
            document.getElementById('main-chart').src = '/static/chart.png?t=' + t;
            document.getElementById('weekly-chart').src = '/static/weekly.png?t=' + t;
        }

        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    // 1. Light Status
                    const lightVal = document.getElementById('light-val');
                    const lightCard = document.getElementById('light-card');
                    const currentStatus = data.light;
                    
                    if (currentStatus === 'on') {
                        lightVal.innerHTML = '<span>üí° –°–≤—ñ—Ç–ª–æ —î</span>';
                        lightCard.className = 'card status-on';
                    } else if (currentStatus === 'off') {
                        lightVal.innerHTML = '<span>‚úñÔ∏è –°–≤—ñ—Ç–ª–æ –∑–Ω–∏–∫–ª–æ</span>';
                        lightCard.className = 'card status-off';
                    }
                    document.getElementById('light-status').innerHTML = data.light_event;
                    
                    // Dynamic Group Name
                    if (data.group) {
                        document.getElementById('group-title').innerText = '–ï–ª–µ–∫—Ç—Ä–æ–ø–æ—Å—Ç–∞—á–∞–Ω–Ω—è (–ì—Ä—É–ø–∞ ' + data.group + ')';
                        document.getElementById('group-schedule-header').innerText = '–ì—Ä–∞—Ñ—ñ–∫ –≥—Ä—É–ø–∏ ' + data.group;
                    }

                    if (lastLightStatus && currentStatus !== lastLightStatus) {
                        refreshCharts();
                    }
                    lastLightStatus = currentStatus;

                    // Schedule Text
                    document.getElementById('schedule-text').innerHTML = data.schedule_text || '–ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π';

                    // Alert
                    const alertCard = document.getElementById('alert-card');
                    const alertVal = document.getElementById('alert-val');
                    const alertStatus = document.getElementById('alert-status');
                    
                    if (data.alert.city) {
                        alertCard.classList.add('alert-active');
                        alertVal.innerText = '‚ö†Ô∏è –¢–†–ò–í–û–ì–ê';
                        alertStatus.innerText = '–ü—Ä–æ–π–¥—ñ—Ç—å –≤ —É–∫—Ä–∏—Ç—Ç—è!';
                    } else {
                        alertCard.classList.remove('alert-active');
                        alertVal.innerText = '–°–ü–û–ö–Ü–ô–ù–û';
                        alertStatus.innerText = '–¢—Ä–∏–≤–æ–≥–∏ –Ω–µ–º–∞—î';
                    }

                    // AQI
                    document.getElementById('aqi-num').innerText = data.aqi.aqi;
                    document.getElementById('aqi-text').innerText = data.aqi.text;
                    document.getElementById('aqi-loc').innerText = data.aqi.location;
                    document.getElementById('pm25').innerText = data.aqi.pm25;
                    document.getElementById('pm10').innerText = data.aqi.pm10;
                    document.getElementById('temp').innerText = data.aqi.temp + ' ¬∞C';
                    document.getElementById('hum').innerText = data.aqi.hum + ' %';
                    document.getElementById('wind-status').innerText = 'üí® ' + data.aqi.wind_dir + ', ' + data.aqi.wind_speed + ' –∫–º/–≥–æ–¥';

                    // Radiation
                    document.getElementById('rad-val').innerText = data.radiation.value + ' –º–∫–ó–≤/–≥–æ–¥';
                    
                    // Time
                    document.getElementById('last-update').innerText = data.timestamp;
                    document.getElementById('update-time').innerText = data.timestamp;
                })
                .catch(err => console.error("Update error:", err));
        }

        setInterval(updateStatus, 30000);
        updateStatus();

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(reg => console.log('SW ok'));
            });
        }
    </script>
</body>
</html>
